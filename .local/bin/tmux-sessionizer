#!/usr/bin/env bash

set -eu -o pipefail

if ! command -v fzf &>/dev/null; then
  echo "fzf not found, install fzf first" && exit 1
fi

explorer_dir="$HOME/Downloads/"
job_dir="$HOME/projects/jobs/level11/pman/"

job_workspaces=$(find "$job_dir" -maxdepth 1 -type d)

personal_workspaces=$(find "$HOME/projects/personal/" -maxdepth 1 -type d)
personal_workspaces="$personal_workspaces
$HOME/Documents/"

read -r -p "Are you working now? [y/n] " is_job
case "$is_job" in
"y" | "Y")
  workspace=$(echo "${job_workspaces[@]}" | fzf)
  ;;
"n" | "N")
  workspace=$(echo "${personal_workspaces[@]}" | fzf)
  ;;
*)
  echo "Invalid option"
  ;;
esac

read -p "Input workspace name (or leave empty to auto-set): " ws_name
workspace_name=${ws_name:=$(basename "$workspace" | sed "s/-//g" | cut -c 1-8)}
if tmux has-session -t "$workspace_name" 2>/dev/null; then
  tmux attach -t "$workspace_name"
else
  tmux new -ds "$workspace_name"
  if [ "$is_job" = "y" ] || [ "$is_job" = "Y" ]; then
    tmux renamew -t 1 "nvim" &&
      tmux send-keys -t "$workspace_name:nvim" "cd $workspace && nvim" C-m

    tmux neww -t "$workspace_name" -n "server" &&
      tmux send-keys -t "$workspace_name:server" "cd $workspace/packages/backend/level11-server/ && make pulse" C-m

    tmux neww -t "$workspace_name" -n "frontend" &&
      tmux send-keys -t "$workspace_name:frontend" "cd $workspace && yarn dev" C-m

    tmux neww -t "$workspace_name" -n "bundler" &&
      tmux send-keys -t "$workspace_name:bundler" "cd $workspace && yarn g:watch" C-m

    tmux neww -t "$workspace_name" -n "explorer" &&
      tmux send-keys -t "$workspace_name:explorer" "yazi $explorer_dir"
  else
    tmux renamew -t 1 "nvim" &&
      tmux send-keys -t "$workspace_name:nvim" "cd $workspace && nvim" C-m
    tmux neww -t "$workspace_name" -n "explorer" &&
      tmux send-keys -t "$workspace_name:explorer" "yazi $explorer_dir"
  fi
  tmux attach -t "$workspace_name"
fi

unset -v explorer_dir job_dir job_workspaces personal_workspaces workspace workspace_name
